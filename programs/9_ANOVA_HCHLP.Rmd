---
title: "ANOVA for temperature tolerance"
author: "Emma Chandler"
date: "September 11, 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Libraries
```{r}
library(dplyr)
library(ggplot2)
library(rcompanion)
library(MASS)
library(moments)
library(plyr)
library(lmerTest)
library(lme4)

```


## Load Data
```{r}
remove(list = ls())

H.CHPL <- read.csv("~/Horsenettle/data/chlorophylldata.csv", header = TRUE)

```

## Calculate CHPL
```{r}

# Create columns with proportions
trtpro <- H.CHPL$treatment_final / H.CHPL$treatment_initial
cntrpro <- H.CHPL$control_final / H.CHPL$control_initial

# Calculate H.CHPL damage using proportions
H.CHPL$CHPL <- 1 - (cntrpro - trtpro)



```




# Is there variance between regions, while accounting for block, population, and genet as random effects?
```{r}
HCHPL_lmer1 <- lmer(CHPL ~ location + (1|population:ID) + (1|ramet), data = H.CHPL)

(HCHPL_lmer1.a <- anova(HCHPL_lmer1))
summary(HCHPL_lmer1.a)
(HCHPL_lmer1.r <- ranova(HCHPL_lmer1))


# Data Visualization
(H.CHPL.p2 <- ggplot(H.CHPL, aes(location, CHPL, fill = location)) + 
    geom_boxplot(fill = c("#8EE5EE", "#EEA9B8"),alpha = 0.8, colour = c("#00008B", "#8B1A1A")) +
    theme_classic()+
    theme(axis.text.x = element_text(size = 12, angle = 0)) +
    labs(x = "Region", y = "CHPL"))

```



## Is there variation in temperature tolerance between genets with ramet as replicates
```{r}
HCHPL_lmer2 <- lmer(CHPL ~ ID + (1|ramet), data = H.CHPL)

(HCHPL_lmer2.a <- anova(HCHPL_lmer2))
(HCHPL_lmer2.r <- ranova(HCHPL_lmer2))



#Crate summarised data
detach(package:plyr)

summary <- H.CHPL %>% group_by(ID) %>% 
  summarise(mean = mean(CHPL),sd = sd(CHPL))

# dot plot
(H.CHPL.dot <- ggplot(summary, aes(x = reorder(ID, mean), y = mean)) +
    geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.2) +
    geom_point(size = 3) +
    theme_classic() +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 0.5)) +
    labs(x = "Genotype", y = "CHPL"))


```

ANOVA https://daviddalpiaz.github.io/appliedstats/analysis-of-variance.html 
https://cran.r-project.org/web/packages/lmerTest/lmerTest.pdf 
https://www.r-bloggers.com/2017/06/linear-models-anova-glms-and-mixed-effects-models-in-r/ 


# 1 ) Is there variance between populations?
```{r}
# Data Visualization
(H.CHPL.p1 <- ggplot(H.CHPL, aes(x = reorder(population, CHPL), CHPL, fill = location)) + 
    geom_boxplot(alpha = 0.8) +
    scale_fill_manual(values = c("#00008B", "#FF4040")) +
    theme_classic() +
    theme(axis.text.x = element_text(size = 12, angle = 0)) +
    labs(x = "Population", y = "CHPL"))
```


# 2) Is there variance between Regions?
```{r}
# Data Visualization
(H.CHPL.p2 <- ggplot(H.CHPL, aes(location, CHPL, fill = location)) + 
    geom_boxplot(fill = c("#00008B", "#FF4040"),alpha = 0.8, colour = c("#00008B", "#FF4040")) +
    theme_classic()+
    theme(axis.text.x = element_text(size = 12, angle = 0)) +
    labs(x = "Region", y = "CHPL"))

```



# 3) Is there variation between Genotypes?
```{r}
# Data Visualization
HCHPL_means <- aggregate(CHPL ~ ID, data=H.CHPL, mean)
HCHPL_means <- HCHPL_means %>% 
  mutate(location = case_when(
    grepl("CE", ID) ~ "South",
    grepl("RE", ID) ~ "South", 
    grepl("OP", ID) ~ "South",
    grepl("FR", ID) ~ "North",
    grepl("PI", ID) ~ "North"))

(H.CHPL.p3 <- ggplot(HCHPL_means, aes(x = reorder(ID, CHPL), CHPL, fill = location)) + 
    geom_col() +
    scale_fill_manual(values = c("#00008B", "#FF4040")) +
    theme_classic() +
    theme(axis.text.x = element_text(size = 12, angle = 90)) +
    labs(x = "Genotype", y = "CHPL"))


```


# 4) Is there variation between ramets of a genotype?
```{r}
# Data Visualization
(H.CHPL.p4 <- ggplot(H.CHPL, aes(x = ramet, y = CHPL, group = ID, colour = location)) + 
    geom_point() +
    geom_line() +
    scale_color_manual(values = c("#00008B", "#FF4040")) +
    theme_classic() +
    theme(axis.text.x = element_text(size = 12, angle = 0)) +
    labs(x = "Block", y = "CHPL"))

```



# 5) Is there variance between location when genotype is nested in popultation and location and with block effects?
```{r}
# Data Visualization
(H.CHPL.p1 <- ggplot(H.CHPL, aes(x = ramet, CHPL, fill = location)) + 
    geom_boxplot(alpha = 0.8) +
    scale_fill_manual(values = c("#00008B", "#FF4040")) +
    theme_classic() +
    theme(axis.text.x = element_text(size = 12, angle = 0)) +
    labs(x = "Block", y = "CHPL"))
```



# Post hoc test
```{r}
# Check for homoscedasticity
par(mfrow=c(2,2))
plot(HCHPL.m1)
par(mfrow=c(1,1))


# Post hoc test
(tukey.population<-TukeyHSD(HCHPL.m1))

plot(tukey.population, las = 1)
```

Selecting models from aov https://www.scribbr.com/statistics/anova-in-r/ 

Using linear models and anova https://rc2e.com/linearregressionandanova 


## Check Normality
```{r}
# Original Data
hist(H.CHPL$CHPL, main = "Raw Data", xlab = "CHPL")
shapiro.test(H.CHPL$CHPL)
skewness(H.CHPL$CHPL)

# NOT NORMALLY DISTRIBUTED!! 
# Very negatively skewed.


# cube transformation
CB_CHPL<- (H.CHPL$CHPL)^3
hist(CB_CHPL, main = "cube transformed")
shapiro.test(CB_CHPL)

# square transformation
SQ_CHPL<- (H.CHPL$CHPL)^2
hist(SQ_CHPL, main = "squared transformed")
shapiro.test(SQ_CHPL)

# square root transformation
SQRT_CHPL <- sqrt(H.CHPL$CHPL)
hist(SQRT_CHPL, main = "square root transformed")
shapiro.test(SQRT_CHPL)

# cube root transformed
CHPL <- sign(H.CHPL$CHPL) * abs(H.CHPL$CHPL)^(1/3)
hist(CHPL, main = "cube root transformed")
shapiro.test(CHPL)

# log transformed
LOG_CHPL <- log(H.CHPL$CHPL)
hist(LOG_CHPL, main = "log transformed")
shapiro.test(LOG_CHPL)

# reciprocal root
RR_CHPL <- -(1/(H.CHPL$CHPL^0.5))
hist(RR_CHPL, main = "reciprocal root transformed")
shapiro.test(RR_CHPL)

# reciprocal 
R_CHPL <- -(1/(H.CHPL$CHPL))
hist(R_CHPL, main = "reciprocal transformed")
shapiro.test(R_CHPL)

# reciprocal square
R_CHPL <- -(1/(H.CHPL$CHPL)^2)
hist(R_CHPL, main = "reciprocal square transformed")
shapiro.test(R_CHPL)

# arcsin sqrt transformation 
AST_CHPL <- asin(sqrt(H.CHPL$CHPL/100))
hist(AST_CHPL, main = "arcsin sqrt transformed")
shapiro.test(AST_CHPL)

# All histograms
par(mfrow=c(3,2))
plotNormalHistogram(H.CHPL$CHPL, main = "Raw")
plotNormalHistogram(CHPL, main = "Square Transformed")
plotNormalHistogram(SQRT_CHPL, main = "Square root Transformed")
plotNormalHistogram(CHPL, main = "Cuberoot Transformed")
plotNormalHistogram(LOG_CHPL, main = "Log Transformed")


# The cubed root transformation has the most normal distribution and the highest shapiro-whilk test p-value
# Add cubed root transformation to data frame
H.CHPL$CHPL <- CHPL



```
Transforming data https://daviddalpiaz.github.io/appliedstats/transformations.html
Ladder of powers http://seismo.berkeley.edu/~kirchner/eps_120/Toolkits/Toolkit_03.pdf ```

