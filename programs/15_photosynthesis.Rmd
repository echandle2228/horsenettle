---
title: "Photosynthesis Analysis"
author: "Emma Chandler"
date: "October 13, 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Libraries
```{r message=FALSE}
library(ggplot2)
library(dplyr)
library(ggplot2)
library(rcompanion)
library(MASS)
library(moments)
library(plyr)
library(lmerTest)
library(lme4)
library(ggstatsplot)
library(tidyverse)
library(tidyr)
library(reshape2)

library(multcomp)
library(car)
```


## Load Data
```{r}
remove(list = ls())

PS <- read.csv("~/Horsenettle/data/photosynthesis.csv", header = TRUE)

```

## Process Data - add NA to blank cells
```{r}
# add NA to blank cells
PS[PS == ""] <- NA
PS[PS == "na"] <- NA
PS[PS == " "] <- NA

# Change photosynthesis measurements character to numeric
PS$CPS_i <- as.numeric(PS$CPS_i)
PS$CPS_f <- as.numeric(PS$CPS_f)
PS$HPS_i <- as.numeric(PS$HPS_i)
PS$HPS_f <- as.numeric(PS$HPS_f)

summary(PS)

```



## Differences between north and south for the initial measurements
```{r}

# Is there a difference between the two initial measurements
t.test(PS$CPS_i, PS$HPS_i)

# Mixed effects model checking difference between regions
PSL.origin <- lmer(CPS_i ~ location + (1|ramet) + (1|population), data = PS)

anova(PSL.origin)
ranova(PSL.origin)

# One-way ANOVA checking difference between genets
PSL.origin2 <- aov(CPS_i ~ID, PS)

summary.aov(PSL.origin2)


```

## Calculating the proportion of photosynthesis before and after treatment
```{r}
# Calculating photosynthesis ratio
PS$CPS <- PS$CPS_f / PS$CPS_i
PS$HPS <- PS$HPS_f / PS$HPS_i
```

## Omit data below one standard error of the mean
```{r}

# Create a function for standard error
# SE <- function(x) sd(x)/sqrt(length(x))

# Excluding values greater than 1 and less than 0
C_PS <- PS %>%   
  dplyr::select(population:block, CPS) %>% 
  filter(CPS <= 1, CPS > 0)


H_PS <- PS %>%   
  dplyr::select(population:block, HPS) %>% 
  filter(HPS <= 1, HPS > 0)

# Export data frame for Correlation
# write.csv(x = C_PS, file = "~/Horsenettle/data/processed/CPS.csv")
# write.csv(x = H_PS, file = "~/Horsenettle/data/processed/HPS.csv")


```




## Check normality of differences
```{r}

# Cold Treatment
hist(C_PS$CPS, main = "Cold Treatment", xlab = "Photosynthesis")
shapiro.test(PS$CPS)

# Hot Treatment
hist(H_PS$HPS, main = "Hot Treatment", xlab = "Photosynthesis")
shapiro.test(PS$HPS)

```


## Creating a figure theme for all plots
```{r}
HStheme <- function(){            
  theme_bw()+                          
  theme(axis.text.x = element_text(size = 12), 
        text = element_text(family = "sans"), 
        axis.text.y = element_text(size = 12),
        plot.subtitle = element_text(size = 16, vjust = 1, hjust = 0.5),
        axis.title = element_text(size = 14),
        panel.grid = element_blank(),
        plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), units = , "cm"),
        plot.title = element_text(size = 20, vjust = 1, hjust = 0.5),
        legend.text = element_text(size = 12),
        legend.title = element_blank())
}
```


# Cold Photosynthesis 
Is there variance between regions, while accounting for block, population, and genet as random effects?
```{r}

# Model
CPS_lmer1 <- lmer(CPS ~ location + (1|ramet) + (1|population:ID), data = C_PS)

(CPS_lmer1.a <- anova(CPS_lmer1))
(CPS_lmer1.r <- ranova(CPS_lmer1))


# Data Visualization
(CPS.p1 <- ggplot(C_PS, aes(x = location, CPS, fill = location)) + 
    geom_boxplot(alpha = 0.8) +
    scale_fill_manual(values = c("#104E8B", "#CD2626")) +
    HStheme() +
    theme(legend.position = "none") +
    labs(x = "Region", y = bquote(Delta* ' Net Photosynthesis'), title = "Photosynthesis", subtitle = "Cold Treatment"))


# Saving graph
ggsave("figures/CPS.p1.png", width = 7, height = 5, dpi = 300)

```


```{r}

CPS_lmer1 <- lmer(CPS ~ location + (1|ID), data = C_PS)

Anova(CPS_lmer1, type="III")

postHocs <- glht(CPS_lmer1, linfct = mcp(location = "Tukey"))
summary(postHocs)


```





# Hot Photosynthesis
Is there variance between regions, while accounting for block, population, and genet as random effects?
```{r}

# Model
HPS_lmer1 <- lmer(HPS ~ location + (1|ramet) + (1|population:ID), data = H_PS)
HPS_lmer1 <- lmer(HPS ~ location + (1|ramet) + (1|population), data = H_PS)

(HPS_lmer1.a <- anova(HPS_lmer1))
(HPS_lmer1.r <- ranova(HPS_lmer1))


# Data Visualization
(HPS.p1 <- ggplot(H_PS, aes(x = location, HPS, fill = location)) + 
    geom_boxplot(alpha = 0.8) +
    scale_fill_manual(values = c("#104E8B", "#CD2626")) +
    HStheme() +
    theme(legend.position = "none") +
    labs(x = "Region", y = bquote(Delta* ' Net Photosynthesis'), title = "Photosynthesis", subtitle = "Hot Treatment"))


# Saving graph
ggsave("figures/HPS.p1.png", width = 7, height = 5, dpi = 300)

```
```{r}

HPS_lmer1 <- lmer(HPS ~ location + (1|ID), data = H_PS)

Anova(HPS_lmer1, type="III")

postHocs <- glht(HPS_lmer1, linfct = mcp(location = "Tukey"))
summary(postHocs)


```

## Is there differences in variation between north and south
```{r}
reg <- bartlett.test(CPS ~ location, data = C_PS)
reg


reg <- bartlett.test(HPS ~ location, data = H_PS)
reg

```




## Cold Photosynthesis
Is there variation in temperature tolerance between genets with ramet as replicates
```{r}
CPS_aov2 <- aov(CPS ~ ID, data = C_PS)
summary(CPS_aov2)


#Create summarised data
detach(package:plyr)

summary1 <- C_PS %>%  
  drop_na(CPS)%>% 
  group_by(ID, location) %>%
  summarise(mean = mean(CPS),sd = sd(CPS)) 
  

# dot plot
(CPS.dot <- ggplot(summary1, aes(x = reorder(ID, mean), y = mean)) +
    geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.2) +
    geom_point(size = 3, aes(colour = location)) +
    scale_color_manual(values = c("#104E8B", "#CD2626"))+
    HStheme() +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 0.5)) +
    labs(x = "Genotype", y = bquote(Delta* ' Net Photosynthesis'), title = "Photosynthesis", subtitle = "Cold Treatment"))

# Saving graph
ggsave("figures/CPS.p2.png", width = 7, height = 5, dpi = 300)

```


## Hot Photosynthesis
Is there variation in temperature tolerance between genets with ramet as replicates
```{r}
HPS_aov2 <- aov(HPS ~ ID, data = H_PS)
summary(HPS_aov2)


#Create summarised data
summary2 <- H_PS %>%  
  drop_na(HPS)%>% 
  group_by(ID, location) %>%
  summarise(mean = mean(HPS),sd = sd(HPS)) 
  

# dot plot
(CPS.dot <- ggplot(summary2, aes(x = reorder(ID, mean), y = mean)) +
    geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.2) +
    geom_point(size = 3, aes(colour = location)) +
    scale_color_manual(values = c("#104E8B", "#CD2626"))+
    HStheme() +
    theme(axis.text.x = element_text(size = 10, angle = 90, hjust = 0.5)) +
    labs(x = "Genotype", y = bquote(Delta* ' Net Photosynthesis'), title = "Photosynthesis", subtitle = "Hot Treatment"))

# Saving graph
ggsave("figures/HPS.p2.png", width = 7, height = 5, dpi = 300)

```


## Is there variation in genets for the individual regions?
```{r}
# Is there variation in the individuals with in the independent Regions
# Hot Photosynthesis
#North
H.PS_N <- H_PS %>% 
  filter(location == "North")

H.PS_N <- aov(HPS ~ ID, data = H.PS_N)
summary(H.PS_N)


#South
H.PS_S <- H_PS %>% 
  filter(location == "South")

H.PS_S <- aov(HPS ~ ID, data = H.PS_S)
summary(H.PS_S)



# Cold Photosynthesis
#North
C.PS_N <- C_PS %>% 
  filter(location == "North")

C.PS_N <- aov(CPS ~ ID, data = C.PS_N)
summary(C.PS_N)


#South
C.PS_S <- C_PS %>% 
  filter(location == "South")

C.PS_S <- aov(CPS ~ ID, data = C.PS_S)
summary(C.PS_S)

```



# 1 ) Is there variance between populations Cold?
```{r}


# Data Visualization
(C.PS.p1 <- ggplot(C_PS, aes(x = reorder(population, CPS), CPS, fill = location)) + 
    geom_boxplot(alpha = 0.8) +
    scale_fill_manual(values = c("#104E8B", "#CD2626")) +
    HStheme() + 
    theme(axis.text.x = element_text(size = 12, angle = 0)) +
    labs(x = "Population", y = "Net Photosynthetic Rate"))

# Saving graph
ggsave("figures/C.PS.POPULATION.png", width = 7, height = 5, dpi = 300)

```


# 1 ) Is there variance between populations Hot?
```{r}

# Data Visualization
(H.PS.p1 <- ggplot(H_PS, aes(x = reorder(population, HPS), HPS, fill = location)) + 
    geom_boxplot(alpha = 0.8) +
    scale_fill_manual(values = c("#104E8B", "#CD2626")) +
    HStheme() + 
    theme(axis.text.x = element_text(size = 12, angle = 0)) +
    labs(x = "Population", y = "Net Photosynthetic Rate"))

# Saving graph
ggsave("figures/H.PS.POPULATION.png", width = 7, height = 5, dpi = 300)

```
