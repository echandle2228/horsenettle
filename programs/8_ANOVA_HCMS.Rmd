---
title: "ANOVA for temperature tolerance"
author: "Emma Chandler"
date: "September 11, 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Libraries
```{r message = FALSE}
library(dplyr)
library(ggplot2)
library(rcompanion)
library(MASS)
library(moments)
library(plyr)
library(lmerTest)
library(lme4)
library(ggstatsplot)
library(outliers)
library(EnvStats)
library(tidyverse)
library(multcompView)
library(ggpubr)
library(agricolae)
library(pander)
library(broom)
library(lawstat)

library(multcomp)
library(car)

```



## Load Data
```{r}
remove(list = ls())

H.CMS <- read.csv("~/Horsenettle/data/CMSdata.csv", header = TRUE)

```


## Differences between north and south for the initial measurements
```{r}

# Is there a difference between the two max damage measurements
t.test(H.CMS$exp_max, H.CMS$cntr_max)

# Mixed effects model checking difference between regions
HCMSL.origin <- lmer(exp_max ~ location + (1|ramet) + (1|population), data = H.CMS)

anova(HCMSL.origin)
ranova(HCMSL.origin)

# One-way ANOVA checking difference between genets
HCMSL.origin2 <- aov(exp_max ~ID, H.CMS)

summary.aov(HCMSL.origin2)

```



## Calculate CMS 
```{r}
# Create  proportions of damage over max
trtpro <- H.CMS$exp_trt / H.CMS$exp_max
cntrpro <- H.CMS$cntr_trt / H.CMS$cntr_max

# Calculate CMS using proportions
H.CMS$CMS <- ((1 - trtpro)/(1 - cntrpro))

# Export data frame for Correlation
# write.csv(x = H.CMS, file = "~/Horsenettle/data/processed/H.CMS.csv")

```

## Test for outliers
https://vsp.pnnl.gov/help/vsample/rosners_outlier_test.htm  
```{r}

# Create a boxplot of the dataset, outliers are shown as two distinct points
(outliers <- boxplot(data = H.CMS, CMS~location, plot=TRUE)$out)  

# Use number of potential outliers from previous code
rosner <- rosnerTest(H.CMS$CMS, k = 4)
rosner$all.stats
# No Outliers

```

# Creating a figure theme for all plots
```{r}
HStheme <- function(){            
  theme_bw()+                          
  theme(axis.text.x = element_text(size = 12), 
        text = element_text(family = "sans"), 
        axis.text.y = element_text(size = 12),
        plot.subtitle = element_text(size = 16, vjust = 1, hjust = 0.5),
        axis.title = element_text(size = 12),
        panel.grid = element_blank(),
        plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), units = , "cm"),
        plot.title = element_text(size = 20, vjust = 1, hjust = 0.5),
        legend.text = element_text(size = 12),
        legend.title = element_blank())
}
```



# Is there variance between regions, while accounting for block, population, and genet as random effects?
```{r}
HCMS_lmer1 <- lmer(CMS ~ location + (1|ramet) + (1|population:ID), data = H.CMS)

(HCMS_lmer1.a <- anova(HCMS_lmer1))
(HCMS_glmer1.r <- ranova(HCMS_lmer1))



# Data Visualization
(H.CMS.p1 <- ggplot(H.CMS, aes(ramet, CMS, fill = location)) + 
    geom_boxplot(alpha = 0.8) +
    scale_fill_manual(values = c("#104E8B", "#CD2626")) +
    HStheme() +
    labs(x = "Block", y = "CMS Ratio", title = "Cell Membrane Stability", subtitle = "Hot Treatment"))

# Saving graph
# ggsave("figures/H.CMS.p1.png", width = 7, height = 5, dpi = 300)

(H.CMS.p1 <- ggplot(H.CMS, aes(location, CMS, fill = location)) + 
    geom_boxplot(alpha = 0.8) +
    scale_fill_manual(values = c("#104E8B", "#CD2626")) +
    HStheme() +
    labs(x = "Block", y = "CMS Ratio", title = "Cell Membrane Stability", subtitle = "Hot Treatment"))


# Saving graph
# ggsave("figures/H.CMS.p1b.png", width = 7, height = 5, dpi = 300)
```


## Is there a difference in variation between plants from the north and south using ANCOVA

```{r}


HCMS_lmer1 <- lmer(CMS ~ location + (1|ID), data = H.CMS)

Anova(HCMS_lmer1, type="III")

postHocs <- glht(HCMS_lmer1, linfct = mcp(location = "Tukey"))
summary(postHocs)



```


## Is there a difference in CMS between the blocks
```{r}
HCMS_block <- aov(CMS ~ ramet, H.CMS)
summary(HCMS_block)


posthoc <- TukeyHSD(x=HCMS_block, 'ramet', conf.level=0.95)
posthoc


```











## Is there variation in temperature tolerance between genets with ramet as replicates
```{r}
HCMS_aov2 <- aov(CMS ~ ID, data = H.CMS)

summary(HCMS_aov2)
(HCMS_lmer2.a <- anova(HCMS_aov2))

(TUKEY <- TukeyHSD(HCMS_aov2))
plot(TUKEY, las = 1)

#Crate summarised data
detach(package:plyr)

summary <- H.CMS %>% 
  group_by(ID, location) %>% 
  summarise(mean = mean(CMS),se = sd(CMS)/(sqrt(length(CMS))))

# dot plot
(H.CMS.dot <- ggplot(summary, aes(x = reorder(ID, mean), y = mean)) +
    geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.2) +
    geom_point(size = 3, aes(colour = location)) +
    scale_color_manual(values = c("#104E8B", "#CD2626"))+
    HStheme()+
    stat_compare_means(label = "p.signif", method = "t.test",ref.group = ".all.") + 
    theme(axis.text.x = element_text(size = 10, angle = 90, vjust = 0.5)) +
    labs(x = "Genotype", y = "CMS Ratio", title = "Cell Membrane Stability", subtitle = "Hot Treatment"))

# Saving graph
# ggsave("figures/H.CMS.p2.png", width = 7, height = 5, dpi = 300)

```


## Is there variation in genets for the individual regions?
```{r}
# Is there variation in the individuals with in the independent Regions

#North
H.CMS_N <- H.CMS %>% 
  filter(location == "North")

HCMS_N <- aov(CMS ~ ID, data = H.CMS_N)
summary(HCMS_N)


#South
H.CMS_S <- H.CMS %>% 
  filter(location == "South")

HCMS_S <- aov(CMS ~ ID, data = H.CMS_S)
summary(HCMS_S)



```




# Variance between groups

```{r}
reg <- levene.test(H.CMS$CMS, H.CMS$location)
reg

reg <- bartlett.test(CMS ~ location, data = H.CMS)
reg

```


# 1 ) Is there variance between populations?
```{r}

# ANOVA for populations
pop.aov <- lmer(CMS ~ population + (1|ID) + (1|ramet), data = H.CMS)
summary(pop.aov)


# Data Visualization
(H.CMS.p1 <- ggplot(H.CMS, aes(x = reorder(population, CMS), CMS, fill = location)) + 
    geom_boxplot(alpha = 0.8) +
    scale_fill_manual(values = c("#104E8B", "#CD2626")) +
    HStheme() + 
    theme(axis.text.x = element_text(size = 12, angle = 0)) +
    labs(x = "Population", y = "CMS"))

# Saving graph
ggsave("figures/H.CMS.POPULATION.png", width = 7, height = 5, dpi = 300)

```





Selecting models from aov https://www.scribbr.com/statistics/anova-in-r/ 

Using linear models and anova https://rc2e.com/linearregressionandanova 




## Check Normality
```{r}
# Original Data
hist(H.CMS$CMS, main = "Raw Data", xlab = "CMS")
shapiro.test(H.CMS$CMS)
skewness(H.CMS$CMS)

# NOT NORMALLY DISTRIBUTED!! 
# Very negatively skewed.

# Transformation following ladder of powers

# cube transformation
CB_CMS<- (H.CMS$CMS)^3
hist(CB_CMS, main = "cube transformed")
shapiro.test(CB_CMS)

# square transformation
sq_CMS<- (H.CMS$CMS)^2
hist(sq_CMS, main = "squared transformed")
shapiro.test(sq_CMS)

# square root transformation
SQRT_CMS <- sqrt(H.CMS$CMS)
hist(SQRT_CMS, main = "square root transformed")
shapiro.test(SQRT_CMS)

# cube root transformed
CR_CMS <- sign(H.CMS$CMS) * abs(H.CMS$CMS)^(1/3)
hist(CR_CMS, main = "cube root transformed")
shapiro.test(CR_CMS)

# log transformed
LOG_CMS <- log(H.CMS$CMS)
hist(LOG_CMS, main = "log transformed")
shapiro.test(LOG_CMS)

# reciprocal root
RR_CMS <- -(1/(H.CMS$CMS^0.5))
hist(RR_CMS, main = "reciprocal root transformed")
shapiro.test(RR_CMS)

# reciprocal 
R_CMS <- -(1/(H.CMS$CMS))
hist(R_CMS, main = "reciprocal transformed")
shapiro.test(R_CMS)

# reciprocal square
R_CMS <- -(1/(H.CMS$CMS)^2)
hist(R_CMS, main = "reciprocal square transformed")
shapiro.test(R_CMS)

# arcsin sqrt transformation 
AST_CMS <- asin(sqrt(H.CMS$CMS/100))
hist(AST_CMS, main = "arcsin sqrt transformed")
shapiro.test(AST_CMS)


# All histograms
par(mfrow=c(3,2))
plotNormalHistogram(H.CMS$CMS, main = "Raw")
plotNormalHistogram(SQ_CMS, main = "Square Transformed")
plotNormalHistogram(SQRT_CMS, main = "Square root Transformed")
plotNormalHistogram(CR_CMS, main = "Cuberoot Transformed")
plotNormalHistogram(LOG_CMS, main = "Log Transformed")


# The Square transformation has the most normal distribution and the highest shapiro-whilk test p-value
# Add Squared transformation to data frame
H.CMS$sq_CMS <- sq_CMS

```

Transforming data https://daviddalpiaz.github.io/appliedstats/transformations.html
Ladder of powers http://seismo.berkeley.edu/~kirchner/eps_120/Toolkits/Toolkit_03.pdf 



